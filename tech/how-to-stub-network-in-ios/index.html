<!DOCTYPE html>
<html lang='en'><head>
  <meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<meta name='description' content='There are times we wish to fake a network event, for example, a network error. However, integrating a 3rd party stub library just for this purpose is not really worthy. This post aims at demonstrating how to stub network.'>
<meta name='theme-color' content='#0067a7'>

<meta property='og:title' content='How to stub network in iOS ‚Ä¢ Thuyen&#39;s corner'>
<meta property='og:description' content='There are times we wish to fake a network event, for example, a network error. However, integrating a 3rd party stub library just for this purpose is not really worthy. This post aims at demonstrating how to stub network.'>
<meta property='og:url' content='https://trinhngocthuyen.github.io/tech/how-to-stub-network-in-ios/'>
<meta property='og:site_name' content='Thuyen&#39;s corner'>
<meta property='og:type' content='article'><meta property='article:section' content='tech'><meta property='article:tag' content='ios'><meta property='article:tag' content='swift'><meta property='article:tag' content='testing'><meta property='article:tag' content='stub'><meta property='article:tag' content='network'><meta property='article:published_time' content='2017-11-04T00:00:00Z'/><meta property='article:modified_time' content='2017-11-04T00:00:00Z'/><meta name='twitter:card' content='summary'>

<meta name="generator" content="Hugo 0.55.6" />

  <title>How to stub network in iOS ‚Ä¢ Thuyen&#39;s corner</title>
  <link rel='canonical' href='https://trinhngocthuyen.github.io/tech/how-to-stub-network-in-ios/'>
  
  
  <link rel='icon' href='/favicon.ico'>
<link rel='stylesheet' href='/assets/css/main.d751652e.css'><link rel='stylesheet' href='/css/custom.css'><link rel='stylesheet' href='/css/syntax.css'><style>
:root{--color-accent:#0067a7;}
</style>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69597239-3', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  

</head>
<body class='page type-tech layout-post has-sidebar'>

  <div class='site'><div id='sidebar' class='sidebar'>
  <a class='screen-reader-text' href='#main-menu'>Skip to Main Menu</a>

  <div class='container'><section class='widget widget-about sep-after'>
  <header>
    
    <h2 class='title site-title '>
      <a href='/'>
      Thuyen&#39;s corner
      </a>
    </h2>
    <div class='desc'>
    
    </div>
  </header>

</section>
<section class='widget widget-search sep-after'>
  <header>
    <h4 class='title widget-title'>Search</h4>
  </header>

  <form action='/search' id='search-form' class='search-form'>
    <label>
      <span class='screen-reader-text'>Search</span>
      <input id='search-term' class='search-term' type='search' name='q' placeholder='Search&hellip;'>
    </label></form>

</section>
<section class='widget widget-taxonomy_cloud sep-after'>
  <header>
    <h4 class='title widget-title'>Tags</h4>
  </header>

  <div class='container list-container'>
  <ul class='list taxonomy-cloud no-shuffle'><li>
        <a href='/tags/algebra/' style='font-size:1em'>algebra</a>
      </li><li>
        <a href='/tags/architecture/' style='font-size:1em'>architecture</a>
      </li><li>
        <a href='/tags/astrology/' style='font-size:1em'>astrology</a>
      </li><li>
        <a href='/tags/book-review/' style='font-size:1em'>book-review</a>
      </li><li>
        <a href='/tags/brain-exercises/' style='font-size:1.1176470588235294em'>brain-exercises</a>
      </li><li>
        <a href='/tags/ci/' style='font-size:1em'>ci</a>
      </li><li>
        <a href='/tags/command-line/' style='font-size:1em'>command-line</a>
      </li><li>
        <a href='/tags/compiler/' style='font-size:1em'>compiler</a>
      </li><li>
        <a href='/tags/config/' style='font-size:1em'>config</a>
      </li><li>
        <a href='/tags/creative-thinking/' style='font-size:1.0588235294117647em'>creative-thinking</a>
      </li><li>
        <a href='/tags/decision-making/' style='font-size:1em'>decision-making</a>
      </li><li>
        <a href='/tags/expectation/' style='font-size:1em'>expectation</a>
      </li><li>
        <a href='/tags/garbage-collection/' style='font-size:1em'>garbage-collection</a>
      </li><li>
        <a href='/tags/image-processing/' style='font-size:1em'>image-processing</a>
      </li><li>
        <a href='/tags/ios/' style='font-size:2em'>ios</a>
      </li><li>
        <a href='/tags/logic/' style='font-size:1.0588235294117647em'>logic</a>
      </li><li>
        <a href='/tags/markov-chain/' style='font-size:1em'>markov-chain</a>
      </li><li>
        <a href='/tags/maths/' style='font-size:1.1764705882352942em'>maths</a>
      </li><li>
        <a href='/tags/method-dispatch/' style='font-size:1em'>method-dispatch</a>
      </li><li>
        <a href='/tags/mvvm/' style='font-size:1em'>mvvm</a>
      </li><li>
        <a href='/tags/network/' style='font-size:1em'>network</a>
      </li><li>
        <a href='/tags/neural-networks/' style='font-size:1em'>neural-networks</a>
      </li><li>
        <a href='/tags/optimization/' style='font-size:1.0588235294117647em'>optimization</a>
      </li><li>
        <a href='/tags/paradox/' style='font-size:1em'>paradox</a>
      </li><li>
        <a href='/tags/probability/' style='font-size:1.2352941176470589em'>probability</a>
      </li><li>
        <a href='/tags/problem-solving/' style='font-size:1.1176470588235294em'>problem-solving</a>
      </li><li>
        <a href='/tags/programming/' style='font-size:1.1176470588235294em'>programming</a>
      </li><li>
        <a href='/tags/psychological-efffects/' style='font-size:1em'>psychological-efffects</a>
      </li><li>
        <a href='/tags/questioning/' style='font-size:1em'>questioning</a>
      </li><li>
        <a href='/tags/reading/' style='font-size:1em'>reading</a>
      </li><li>
        <a href='/tags/reasoning/' style='font-size:1.1176470588235294em'>reasoning</a>
      </li><li>
        <a href='/tags/resolution/' style='font-size:1em'>resolution</a>
      </li><li>
        <a href='/tags/retrospection/' style='font-size:1em'>retrospection</a>
      </li><li>
        <a href='/tags/retrospective/' style='font-size:1.0588235294117647em'>retrospective</a>
      </li><li>
        <a href='/tags/science/' style='font-size:1.0588235294117647em'>science</a>
      </li><li>
        <a href='/tags/statistics/' style='font-size:1.1764705882352942em'>statistics</a>
      </li><li>
        <a href='/tags/stub/' style='font-size:1em'>stub</a>
      </li><li>
        <a href='/tags/swift/' style='font-size:1.3529411764705883em'>swift</a>
      </li><li>
        <a href='/tags/swizzle/' style='font-size:1em'>swizzle</a>
      </li><li>
        <a href='/tags/testing/' style='font-size:1em'>testing</a>
      </li><li>
        <a href='/tags/travel/' style='font-size:1.3529411764705883em'>travel</a>
      </li><li>
        <a href='/tags/triz/' style='font-size:1.0588235294117647em'>triz</a>
      </li><li>
        <a href='/tags/ux/' style='font-size:1em'>ux</a>
      </li><li>
        <a href='/tags/xcode/' style='font-size:1em'>xcode</a>
      </li></ul>
</div>


</section>
</div>

  <div class='sidebar-overlay'></div>
</div><div class='main'><nav id='main-menu' class='menu main-menu' aria-label='Main Menu'>
  <div class='container'>
    <a class='screen-reader-text' href='#content'>Skip to Content</a>

<button id='sidebar-toggler' class='sidebar-toggler' aria-controls='sidebar'>
  <span class='screen-reader-text'>Toggle Sidebar</span>
  <span class='open'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="3" y1="12" x2="21" y2="12" />
  <line x1="3" y1="6" x2="21" y2="6" />
  <line x1="3" y1="18" x2="21" y2="18" />
  
</svg>
</span>
  <span class='close'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="18" y1="6" x2="6" y2="18" />
  <line x1="6" y1="6" x2="18" y2="18" />
  
</svg>
</span>
</button>
    <ul><li class='item'>
        <a href='/tech/'>Tech</a>
      </li><li class='item'>
        <a href='/reasoning/'>Reasoning</a>
      </li><li class='item'>
        <a href='/misc/'>Misc</a>
      </li><li class='item'>
        <a href='/about/'>About</a>
      </li></ul>
  </div>
</nav><div class='header-widgets'>
        <div class='container'>
    
    <style>.widget-breadcrumbs li:after{content:'‚â´'}</style>
  <section class='widget widget-breadcrumbs sep-after'>
    <nav id='breadcrumbs'>
      <ol><li><a href='/'>üè° Home</a></li><li><a href='/tech/'>Tech</a></li><li><span>How to stub network in iOS</span></li></ol>
    </nav>
  </section></div>
      </div>

      <header id='header' class='header site-header'>
        <div class='container sep-after'>
          <div class='header-info'><p class='site-title title'>Thuyen&#39;s corner</p><p class='desc site-desc'></p>
          </div>
        </div>
      </header>

      <main id='content'>


<article lang='en' class='entry'>
  <header class='header entry-header'>
  <div class='container sep-after'>
    <div class='header-info'>
      <h1 class='title'>How to stub network in iOS</h1>
      

    </div>
    <div class='entry-meta'>
  <span class='posted-on'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
  <line x1="16" y1="2" x2="16" y2="6"/>
  <line x1="8" y1="2" x2="8" y2="6"/>
  <line x1="3" y1="10" x2="21" y2="10"/>
  
</svg>
<span class='screen-reader-text'>Posted on </span>
  <time class='entry-date' datetime='2017-11-04T00:00:00Z'>2017, Nov 04</time>
</span>

  
  

</div>


  </div>
</header>

  
  
<details class='container entry-toc'>
  <summary class='title'>
    <span>Table of Contents</span>
  </summary>
  <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#fundamental">Fundamental</a>
<ul>
<li><a href="#a-typical-workflow-of-network-requests">A typical workflow of network requests</a></li>
<li><a href="#variations-of-this-workflow">Variations of this workflow</a></li>
</ul></li>
<li><a href="#how-to-stub">How to stub</a>
<ul>
<li><a href="#case-study">Case study</a></li>
<li><a href="#urlprotocol">URLProtocol</a></li>
<li><a href="#let-s-stub">Let&rsquo;s stub</a></li>
<li><a href="#shared-session">Shared session</a></li>
<li><a href="#session-initialized-with-a-configuration">Session initialized with a configuration</a></li>
<li><a href="#another-approach">Another approach</a></li>
</ul></li>
<li><a href="#further-discussion">Further discussion</a>
<ul>
<li><a href="#questions-remained">Questions remained</a></li>
<li><a href="#bizarre-stuffs">Bizarre stuffs</a></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</nav>
</details>


  <div class='container entry-content'>
  

<p>There are times we wish to fake a network event, for example, a network error. However, integrating a 3rd party stub library just for this purpose is not really worthy. This post aims at demonstrating how to stub network. It is not a tutorial on &ldquo;how to create a stubbing framework&rdquo;, therefore, some boundary cases will not be covered so that readers could stay focused.</p>

<h3 id="fundamental">Fundamental</h3>

<h4 id="a-typical-workflow-of-network-requests">A typical workflow of network requests</h4>

<p>A typical workflow to make a network request is:</p>

<ol>
<li>Create a session <code>URLSession</code></li>
<li>Create a task associated with the request: <code>let task = session.dataTask(...) { ... }</code></li>
<li>Start/resume the task by calling <code>task.resume()</code></li>
</ol>

<h4 id="variations-of-this-workflow">Variations of this workflow</h4>

<p>Network requests in iOS may behave differently depending on the configuration of the session. By configuration, I mean <code>URLSessionConfiguration</code>.</p>

<h3 id="how-to-stub">How to stub</h3>

<h4 id="case-study">Case study</h4>

<blockquote>
<p>For debug purpose, we want to create a fake network response for a specific url. For simplicity, we return the response with status code 500.</p>
</blockquote>

<h4 id="urlprotocol">URLProtocol</h4>

<p>This is an abstract class that handles network requests. Note: It is a class although its name sounds like a protocol. By default, there are several subclasses of it each of which takes responsibility for a specific URL scheme (http, ftp, file&hellip;): <code>_NSURLHTTPProtocol, _NSURLDataProtocol, _NSURLFTPProtocol, _NSURLFileProtocol, NSAboutURLProtocol</code>.</p>

<p>When a request is made, the app consults these classes. The first one providing true to <a href="https://developer.apple.com/documentation/foundation/urlprotocol/1411389-caninit"><code>canInit(with:)</code></a> will be given to handle that request.</p>

<h4 id="let-s-stub">Let&rsquo;s stub</h4>

<p>The core idea of stubbing network lies at:
- <em>$H_1$. How we register our custom class (subclass of <code>URLProtocol</code>) to the protocol classes</em>
- <em>$H_2$. How we appoint our class to handle the request</em>
- <em>$H_3$. How we return the appropriate stubbing response</em></p>

<p>We will talk about $H_1$ later because it involves a few cases that should be taken into account. Let&rsquo;s assume that $H_1$ is already done. Then, $H_2$ is quite simple. We just check whether the request was registered to be stubbed or not.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">CustomURLProtocol</span><span class="p">:</span> <span class="n">URLProtocol</span> <span class="p">{</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">var</span> <span class="nv">stubs</span><span class="p">:</span> <span class="p">[</span><span class="nb">String</span><span class="p">:</span> <span class="n">CustomResponse</span><span class="p">]</span> <span class="p">=</span> <span class="p">[:]</span>
	<span class="kr">override</span> <span class="n">open</span> <span class="kd">class</span> <span class="nc">func</span> <span class="n">canInit</span><span class="p">(</span><span class="n">with</span> <span class="n">request</span><span class="p">:</span> <span class="n">URLRequest</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nb">Bool</span> <span class="p">{</span>
    	<span class="k">return</span> <span class="n">url</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="n">stubs</span><span class="p">[</span><span class="n">request</span><span class="p">.</span><span class="n">url</span><span class="o">!</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">nil</span>
	<span class="p">}</span>	

	<span class="kd">class</span> <span class="nc">func</span> <span class="n">addStub</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">CustomResponse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">stubs</span><span class="p">[</span><span class="n">url</span><span class="p">.</span><span class="n">absoluteString</span><span class="p">]</span> <span class="p">=</span> <span class="n">response</span>
	<span class="p">}</span>
	<span class="p">...</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">stub</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">URL</span><span class="p">,</span> <span class="n">statusCode</span><span class="p">:</span> <span class="nb">Int</span><span class="p">)</span> <span class="p">{</span>
	<span class="p">...</span>
	<span class="n">CustomURLProtocol</span><span class="p">.</span><span class="n">addStub</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">CustomResponse</span><span class="p">(</span><span class="n">statusCode</span><span class="p">:</span> <span class="n">statusCode</span><span class="p">))</span>
<span class="p">}</span></code></pre></div>
<p>$H_3$ is achieved by overriding <code>startLoading()</code>. I will not dive into much detail because it is like building a framework. A simple implementation could be like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">class</span> <span class="nc">CustomURLProtocol</span><span class="p">:</span> <span class="n">URLProtocol</span> <span class="p">{</span>
	<span class="p">...</span>
    <span class="kr">override</span> <span class="kd">func</span> <span class="nf">startLoading</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">guard</span> <span class="kd">let</span> <span class="nv">stubResponse</span> <span class="p">=</span> <span class="n">CustomURLProtocol</span><span class="p">.</span><span class="n">stubs</span><span class="p">[</span><span class="n">request</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span> <span class="bp">fatalError</span><span class="p">()</span> <span class="p">}</span> <span class="c1">// Should not happen</span>
        
        <span class="k">switch</span> <span class="n">stubResponse</span> <span class="p">{</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">error</span><span class="p">(</span><span class="kd">let</span> <span class="nv">error</span><span class="p">):</span>
            <span class="n">client</span><span class="p">?.</span><span class="n">urlProtocol</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">didFailWithError</span><span class="p">:</span> <span class="n">error</span><span class="p">)</span>
        <span class="k">case</span> <span class="p">.</span><span class="n">response</span><span class="p">(</span><span class="kd">let</span> <span class="nv">response</span><span class="p">):</span>
            <span class="n">client</span><span class="p">?.</span><span class="n">urlProtocol</span><span class="p">(</span><span class="kc">self</span><span class="p">,</span> <span class="n">didReceive</span><span class="p">:</span> <span class="n">response</span><span class="p">,</span> <span class="n">cacheStoragePolicy</span><span class="p">:</span> <span class="p">.</span><span class="n">allowed</span><span class="p">)</span>
            <span class="n">client</span><span class="p">?.</span><span class="n">urlProtocolDidFinishLoading</span><span class="p">(</span><span class="kc">self</span><span class="p">)</span>
        <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Now comes the crucial part - $H_1$. There are 2 cases to consider: using the shared session, and creating a session with a configuration.</p>

<h4 id="shared-session">Shared session</h4>

<p>The shared session with basic setups is retrieved via <code>URLSession.shared</code>. In that case, we could make out custom <code>URLProtocol</code> subclass visible to the loading system by calling <a href="https://developer.apple.com/documentation/foundation/urlprotocol/1407208-registerclass"><code>URLProtocol.registerClass(_:)</code></a>.</p>

<p>Note that, the process of consulting these protocol classes take place in the reversed order. The latest one to register will be consulted first.</p>

<h4 id="session-initialized-with-a-configuration">Session initialized with a configuration</h4>

<p>The workflow in this case is a bit different. The app does not lookup the protocol classes we register. Rather, it chooses from the classes stored in <code>URLSessionConfiguration.protocolClasses</code>. <code>URLProtocol.registerClass(_:)</code> does not help now&hellip; A solution could be adopted by adding our custom class to <code>configuration.protocolClasses</code>. Make sure to insert it to the top so that it is consulted first.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="n">configuration</span><span class="p">.</span><span class="n">protocolClasses</span> <span class="p">=</span> <span class="p">[</span><span class="n">CustomURLProtocol</span><span class="p">.</span><span class="kc">self</span><span class="p">]</span> <span class="o">+</span> <span class="n">configuration</span><span class="p">.</span><span class="n">protocolClasses</span><span class="o">!</span></code></pre></div>
<p>Everything is nearly done! The only thing left is to make sure the configuration a session is using has the setup above. Fortunately, fow now, we can only create a configuration by either one of the three following.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="kd">let</span> <span class="nv">configuration1</span> <span class="p">=</span> <span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="k">default</span>
<span class="kd">let</span> <span class="nv">configuration2</span> <span class="p">=</span> <span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="n">ephemeral</span>
<span class="kd">let</span> <span class="nv">configuration3</span> <span class="p">=</span> <span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="n">background</span><span class="p">(</span><span class="n">withIdentififer</span><span class="p">:</span> <span class="n">identifier</span><span class="p">)</span></code></pre></div>
<p>Using a configuration created by <code>URLSessionConfiguration()</code> will throw a <a href="https://bugs.swift.org/browse/SR-2226">crash</a>. I am not quite sure if it&rsquo;s a bug or by intention, but I am glad it crashes. Thanks to that, we only have to deal with 3 corner cases. To manipulate the configuration, we can swizzle the getter of <code>.default</code>, <code>.emphemeral</code> and the function <code>.background(withIdentififer:)</code>. The swizzle code should be run once, when we perform the first stub.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// For demo, I only cover the case of `.default`</span>
<span class="kd">let</span> <span class="nv">swizzleDefaultSessionConfiguration</span><span class="p">:</span> <span class="nb">Void</span> <span class="p">=</span> <span class="p">{</span>
	<span class="kd">let</span> <span class="nv">m1</span> <span class="p">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="k">#selector</span><span class="p">(</span><span class="n">getter</span><span class="p">:</span> <span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="k">default</span><span class="p">))</span>
	<span class="kd">let</span> <span class="nv">m2</span> <span class="p">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="k">#selector</span><span class="p">(</span><span class="n">URLSessionConfiguration</span><span class="p">.</span><span class="n">swizzled_defaultSessionConfiguration</span><span class="p">))</span>
	<span class="k">if</span> <span class="kd">let</span> <span class="nv">m1</span> <span class="p">=</span> <span class="n">m1</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">m2</span> <span class="p">=</span> <span class="n">m2</span> <span class="p">{</span> <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}()</span>

<span class="kd">extension</span> <span class="nc">URLSessionConfiguration</span> <span class="p">{</span>
	<span class="kr">@objc</span> <span class="n">dyamic</span> <span class="kd">class</span> <span class="nc">function</span> <span class="n">swizzled_defaultSessionConfiguration</span><span class="p">()</span> <span class="p">-&gt;</span> <span class="n">URLSessionConfiguration</span> <span class="p">{</span>
		<span class="kd">let</span> <span class="nv">configuration</span> <span class="p">=</span> <span class="n">swizzled_defaultSessionConfiguration</span><span class="p">()</span>
		<span class="n">configuration</span><span class="p">.</span><span class="n">protocolClasses</span> <span class="p">=</span> <span class="p">[</span><span class="n">CustomURLProtocol</span><span class="p">.</span><span class="kc">self</span><span class="p">]</span> <span class="o">+</span> <span class="n">configuration</span><span class="p">.</span><span class="n">protocolClasses</span><span class="o">!</span>
		<span class="k">return</span> <span class="n">configuration</span>
	<span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Now, all pieces are ready. Glue them together and enjoy!</p>

<h4 id="another-approach">Another approach</h4>

<p>Instead of taking care of the 2 cases above, we could simply swizzle the init funtions of <code>URLSession</code>. We should swizzle the 2 initializers that take a <code>URLSessionConguration</code> as a param. The beauty of this approach is that we no longer need to register our custom class via <code>URLProtocol.registerClass(_:)</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-swift" data-lang="swift"><span class="c1">// For demo, only `URLSession.init(configuration:)` is swizzled :D</span>
<span class="kd">let</span> <span class="nv">swizzleURLSession</span><span class="p">:</span> <span class="nb">Void</span> <span class="p">=</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">m1</span> <span class="p">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">URLSession</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="k">#selector</span><span class="p">(</span><span class="n">URLSession</span><span class="p">.</span><span class="kd">init</span><span class="p">(</span><span class="n">configuration</span><span class="p">:)))</span>
    <span class="kd">let</span> <span class="nv">m2</span> <span class="p">=</span> <span class="n">class_getClassMethod</span><span class="p">(</span><span class="n">URLSession</span><span class="p">.</span><span class="kc">self</span><span class="p">,</span> <span class="k">#selector</span><span class="p">(</span><span class="n">URLSession</span><span class="p">.</span><span class="n">swizzled_init</span><span class="p">(</span><span class="n">configuration</span><span class="p">:)))</span>
    <span class="k">if</span> <span class="kd">let</span> <span class="nv">m1</span> <span class="p">=</span> <span class="n">m1</span><span class="p">,</span> <span class="kd">let</span> <span class="nv">m2</span> <span class="p">=</span> <span class="n">m2</span> <span class="p">{</span> <span class="n">method_exchangeImplementations</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}()</span>

<span class="kd">extension</span> <span class="nc">URLSession</span> <span class="p">{</span>
    <span class="kr">@objc</span> <span class="kr">dynamic</span> <span class="kd">class</span> <span class="nc">func</span> <span class="n">swizzled_init</span><span class="p">(</span><span class="n">configuration</span><span class="p">:</span> <span class="n">URLSessionConfiguration</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="n">URLSession</span> <span class="p">{</span>
        <span class="n">configuration</span><span class="p">.</span><span class="n">protocolClasses</span> <span class="p">=</span> <span class="p">[</span><span class="n">CustomURLProtocol</span><span class="p">.</span><span class="kc">self</span><span class="p">]</span> <span class="o">+</span> <span class="n">configuration</span><span class="p">.</span><span class="n">protocolClasses</span><span class="o">!</span>
        <span class="k">return</span> <span class="n">swizzled_init</span><span class="p">(</span><span class="n">configuration</span><span class="p">:</span> <span class="n">configuration</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<h3 id="further-discussion">Further discussion</h3>

<p>P/s: TLDR (You can skip this part because details may get you distracted)</p>

<h4 id="questions-remained">Questions remained</h4>

<p>There are a couple of things I have not had reasonable explanations for.</p>

<ul>
<li><p>$P_1$. First of all, why should there be differerences between the 2 cases mentioned above? Is <code>URLSessionConfiguration</code> not enough?</p></li>

<li><p>$P_2$. The documentation says <a href="https://developer.apple.com/documentation/foundation/urlprotocol/1407208-registerclass"><em>&ldquo;Classes are consulted in the reverse order of their registration&rdquo;</em></a>, but the implementation does not seem to work that way. You could take a look at it <a href="https://github.com/apple/swift-corelibs-foundation/blob/a5a248a/Foundation/URLProtocol.swift#L372">here</a> and <a href="https://github.com/apple/swift-corelibs-foundation/blob/swift-4.0-branch/Foundation/URLSession/URLSessionTask.swift#L74">here</a>. The consulted classes are chosen from 2 sources: <code>session.configuration.protocolClasses</code> and <code>URLProtocol._registeredProtocolClasses</code>. But there is no sign of reversion???</p></li>

<li><p>$P_3$. Another thing stopping me from the deep understanding is <a href="https://github.com/apple/swift-corelibs-foundation/blob/swift-4.0-branch/Foundation/URLSession/URLSession.swift#L204"><code>NSUnimplemented()</code></a>. I see it quite often, and have no idea what is actually going on behind it.</p></li>

<li><p>$P_4$. How the program behaves does not exactly match the code in the <a href="https://github.com/apple/swift-corelibs-foundation">swift-corelibs-foundation repo</a>. For example, when first glancing at the code in <code>URLSessionConfiguration</code>, I thought the default configutaion has one item in <code>protocolClasses</code> according to the <a href="https://github.com/apple/swift-corelibs-foundation/blob/swift-4.0-branch/Foundation/URLSession/URLSessionConfiguration.swift#L50">init setup</a>. But the logs show 5 items (<code>_NSURLHTTPProtocol, _NSURLDataProtocol, _NSURLFTPProtocol, _NSURLFileProtocol, NSAboutURLProtocol</code>). A private class method <code>_defaultProtocolClasses()</code> was called and returned these 5 classes. Hmmm, let&rsquo;s not care about them.</p></li>
</ul>

<h4 id="bizarre-stuffs">Bizarre stuffs</h4>

<ul>
<li>$P_5$. A strange thing is that <code>URLSession.init(configuration:)</code> and <code>URLSession.init(configuration:delegate:delegateQueue:)</code> turn out to be class methods, not instance methods. P/s: we could get the instance methods and class methods using this api: <a href="https://developer.apple.com/documentation/objectivec/1418490-class_copymethodlist"><code>class_copyMethodList(_:_:)</code></a>.<br>
<br>After a while investigating, I notice that initializers that have <code>/*not inherited*/</code> in their function signatures (in Apple github) all have the same phenomenon. Also, when subclassing it, these functions are not applicable to be overriden (like what the comment implies), but it is still visible to the invocations. My doubt is that when the framework is built, they are transformed to:<br><br>
<code>swift
	class func `init`(configuration: URLSessionConfiguration) -&gt; URLSession { ... }
</code>
I tried to simulate this situation with a custom class. The logs show a similar result. However, when subclassing that class, Xcode keeps failing to compile due to not being able to check the subclass type. So I think my suspicion is not quite correct, but it&rsquo;s still reasonable to me :). Anyway, that&rsquo;s not a big deal!


Finally, if a stubbing framework is what you are looking for, <a href="https://github.com/kylef/Mockingjay">Mockingjay</a> is my recommendation :D.

### Reference
1. <a href="https://github.com/kylef/Mockingjay">Mockingjay source code</a>
2. <a href="https://www.raywenderlich.com/59982/nsurlprotocol-tutorial">NSURLProtocol Tutorial by Ray Wenderlich</a>
3. <a href="https://github.com/apple/swift-corelibs-foundation">Swift core libraries: swift-corelibs-foundation</a></li>
</ul>

</div>

  
<footer class='entry-footer'>
  <div class='container sep-before'><div class='categories'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M22,19a2,2,0,0,1-2,2H4a2,2,0,0,1-2-2V5A2,2,0,0,1,4,3H9l2,3h9a2,2,0,0,1,2,2Z"/>
  
</svg>
<span class='screen-reader-text'>Categories: </span><a class='category' href='/categories/tech/'>Tech</a></div>
<div class='tags'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M20.59,13.41l-7.17,7.17a2,2,0,0,1-2.83,0L2,12V2H12l8.59,8.59A2,2,0,0,1,20.59,13.41Z"/>
  <line x1="7" y1="7" x2="7" y2="7"/>
  
</svg>
<span class='screen-reader-text'>Tags: </span><a class='tag' href='/tags/ios/'>ios</a> <a class='tag' href='/tags/swift/'>swift</a> <a class='tag' href='/tags/testing/'>testing</a> <a class='tag' href='/tags/stub/'>stub</a> <a class='tag' href='/tags/network/'>network</a></div>

  </div>
</footer>


</article>

<nav class='entry-nav'>
  <div class='container'><div class='prev-entry sep-before'>
      <a href='/tech/quick-thoughts-on-tail-recursion-in-swift/'>
        <span aria-hidden='true'><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="20" y1="12" x2="4" y2="12"/>
  <polyline points="10 18 4 12 10 6"/>
  
</svg>
 Previous</span>
        <span class='screen-reader-text'>Previous post: </span>Quick thoughts on Tail recursion in Swift</a>
    </div><div class='next-entry sep-before'>
      <a href='/tech/an-example-of-survey-with-privacy/'>
        <span class='screen-reader-text'>Next post: </span>An example of Survey with privacy<span aria-hidden='true'>Next <svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <line x1="4" y1="12" x2="20" y2="12"/>
  <polyline points="14 6 20 12 14 18"/>
  
</svg>
</span>
      </a>
    </div></div>
</nav>


<section id='comments' class='comments'>
  <div class='container sep-before'>
    
    
    <div id="fb-root"></div>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v3.3"></script>
<div class="share">
  <div class="fb-like" data-href="https://trinhngocthuyen.github.io/tech/how-to-stub-network-in-ios/" data-width="" data-layout="standard" data-action="like" data-size="small" data-share="true"></div>
</div>


    
    
    <div class='comments-area'>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "trinhngocthuyen-github-io" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
  </div>
</section>


      </main>

      <footer id='footer' class='footer'>
        <div class='container sep-before'><section class='widget widget-social_menu sep-after'><nav aria-label='Social Menu'>
    <ul><li>
        <a href='https://github.com/trinhngocthuyen' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Github account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
  
</svg>
</a>
      </li><li>
        <a href='https://twitter.com/trinhngocthuyen' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Twitter account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
  
</svg>
</a>
      </li><li>
        <a href='mailto:trinhngocthuyen@gmail.com' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Contact via Email</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
  <polyline points="22,6 12,13 2,6"/>
  
</svg>
</a>
      </li><li>
        <a href='https://linkedin.com/in/thuyen-trinh' target='_blank' rel='noopener'>
          <span class='screen-reader-text'>Open Linkedin account in new tab</span><svg class='icon' viewbox='0 0 24 24' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' aria-hidden='true'>
  
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
  <rect x="2" y="9" width="4" height="12"/>
  <circle cx="4" cy="4" r="2"/>
  
</svg>
</a>
      </li></ul>
  </nav>
</section><div class='copyright'>
  <p></p>
</div>

        </div>
      </footer>

    </div>
  </div><script>window.__assets_js_src="/assets/js/"</script>

<script src='/assets/js/main.69694257.js'></script><script type='text/x-mathjax-config'>
  MathJax.Hub.Config({"HTML-CSS":{"availableFonts":["TeX"],"linebreaks":{"automatic":true},"scale":90},"TeX":{"Macros":{"dim":["{\\color{gray}#1}",1],"txt":["\\hspace{3pt}\\text{#1}\\hspace{3pt}",1]},"TagSide":"left","extensions":["color.js"]},"extensions":["tex2jax.js","TeX/AMSmath.js","TeX/AMSsymbols.js"],"jax":["input/TeX","output/HTML-CSS"],"tex2jax":{"displayMath":[["$$","$$"],["\\[","\\]"]],"inlineMath":[["$","$"],["\\(","\\)"]],"processEnvironments":true,"processEscapes":true}})
</script>

<script type='text/javascript' async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML'></script>

</body>

</html>

